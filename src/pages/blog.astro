---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import ImgComp from "../components/ImgComp.astro";
const pageTitle = "Blogs";
const allPosts = await getCollection("blog");

// Pagination logic
const POSTS_PER_PAGE = 10;
const currentPage = Astro.url.searchParams.get("page")
    ? parseInt(Astro.url.searchParams.get("page"))
    : 1;

const filteredPosts = allPosts.sort(
    (a, b) =>
        new Date(b.data["Published on"]).getTime() -
        new Date(a.data["Published on"]).getTime()
);
const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
const start = (currentPage - 1) * POSTS_PER_PAGE;
const end = start + POSTS_PER_PAGE;
const paginatedPosts = filteredPosts.slice(start, end);
---

<BaseLayout pageTitle={pageTitle}>
    <div class="blogs">
        <div class="block">
            <h3>{pageTitle}</h3>
            <br>
            <p>
                Dive into a series of posts exploring the fascinating world of
                physics. <br> From foundational concepts to advanced theories, each
                article reflects my learning journey <br> and curiosity about how the
                universe works.
            </p>
        </div>

        <!-- 🔍 Search Bar (Client-only) -->
        <div class="search-wrapper">
            <input
                type="text"
                id="search-input"
                placeholder="Search posts..."
            />
        </div>

        <div class="post--list" id="post-list">
            {
                paginatedPosts.map((post: any) => (
                    <article
                        class="post"
                        data-title={post.data.title.toLowerCase()}
                    >
                        <div class="image--container">
                            <ImgComp src={post.data.image.url} alt={post.data.image.alt} />
                            
                        </div>
                        <div class="content--container">
                            <h1>
                                <a href={`/posts/${post.id}/`}>
                                    {post.data.title}
                                </a>
                            </h1>
                            <p>{post.data.description}</p>
                            <small>
                                {post.data.author} -{" "}
                                {new Date(
                                    post.data["Published on"]
                                ).toLocaleDateString()}
                            </small>
                            <div class="categories">
                                {post.data.tags.map((tag: any) => (
                                    <a href={`/tags/${tag}`} class="category">
                                        {tag}
                                    </a>
                                ))}
                            </div>
                        </div>
                    </article>
                ))
            }
        </div>

        <!-- 📄 Pagination -->
        <div class="pagination">
            {
                Array.from({ length: totalPages }, (_, i) => i + 1).map(
                    (pageNum) => (
                        <a
                            href={`?page=${pageNum}`}
                            class={`page-link ${pageNum === currentPage ? "active" : ""}`}
                        >
                            {pageNum}
                        </a>
                    )
                )
            }
        </div>
    </div>

    <!-- Search functionality (client-side only) -->
    <script>
        document
            .getElementById("search-input")
            .addEventListener("input", function () {
                const searchTerm = this.value.toLowerCase();
                const posts = document.querySelectorAll(".post");
                posts.forEach((post) => {
                    const title = post.getAttribute("data-title");
                    post.style.display = title.includes(searchTerm)
                        ? "flex"
                        : "none";
                });
            });
    </script>
</BaseLayout>
